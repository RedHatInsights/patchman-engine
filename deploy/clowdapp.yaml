---
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: patchman
objects:
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdApp
  metadata:
    name: patchman
  spec:
    envName: ${ENV_NAME}
    deployments:
    - name: admin
      minReplicas: ${{REPLICAS_ADMIN}}
      webServices:
        public:
          enabled: true
        private:
          enabled: false
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_ADMIN}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - admin
        env:
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVAL_TOPIC, value: patchman.evaluator.recalc}
        - {name: ENABLE_REPO_BASED_RE_EVALUATION, value: '${ENABLE_REPO_BASED_RE_EVALUATION}'}
        - {name: ENABLE_RECALC_MESSAGES_SEND, value: '${ENABLE_RECALC_MESSAGES_SEND}'}
        - {name: ENABLE_ADVISORIES_SYNC, value: '${ENABLE_ADVISORIES_SYNC}'}
        - {name: ENABLE_PACKAGES_SYNC, value: '${ENABLE_PACKAGES_SYNC}'}
        - {name: ENABLE_REPOS_SYNC, value: '${ENABLE_REPOS_SYNC}'}
        - {name: ENABLE_MODIFIED_SINCE_SYNC, value: '${ENABLE_MODIFIED_SINCE_SYNC}'}
        - {name: ERRATA_PAGE_SIZE, value: '${ERRATA_PAGE_SIZE}'}
        - {name: PACKAGES_PAGE_SIZE, value: '${PACKAGES_PAGE_SIZE}'}
        - {name: MSG_BATCH_SIZE, value: '${MSG_BATCH_SIZE}'}
        - {name: ENABLE_TURNPIKE_AUTH, value: '${ENABLE_TURNPIKE_AUTH}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_DATABASE_ADMIN}'}

        resources:
          limits: {cpu: '${RES_LIMIT_CPU_ADMIN}', memory: '${RES_LIMIT_MEM_ADMIN}'}
          requests: {cpu: '${RES_REQUEST_CPU_ADMIN}', memory: '${RES_REQUEST_MEM_ADMIN}'}

    - name: manager
      minReplicas: ${{REPLICAS_MANAGER}}
      webServices:
        public:
          enabled: true
          apiPath: patch
        private:
          enabled: true
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_MANAGER}
        initContainers:
          - name: db-migration
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/entrypoint.sh
            env:
            - {name: LOG_LEVEL, value: '${LOG_LEVEL_DATABASE_ADMIN}'}
            - {name: DB_DEBUG, value: '${DB_DEBUG_DATABASE_ADMIN}'}
            - {name: GIN_MODE, value: '${GIN_MODE}'}
            - {name: SHOW_CLOWDER_VARS, value: ''}
            - {name: SHOW_CLOWDER_VARS, value: ''}
            - {name: WAIT_FOR_DB, value: 'empty'}
            - {name: MANAGER_PASSWORD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                                  key: manager-database-password}}}
            - {name: LISTENER_PASSWORD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                                  key: listener-database-password}}}
            - {name: EVALUATOR_PASSWORD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                                    key: evaluator-database-password}}}
            - {name: VMAAS_SYNC_PASSWORD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                                    key: vmaas-sync-database-password}}}
            - {name: CYNDI_PASSWORD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                                key: cyndi-database-password}}}
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - manager
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_MANAGER}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: SHOW_CLOWDER_VARS, value: ''}
        - {name: DB_DEBUG, value: '${DB_DEBUG_MANAGER}'}
        - {name: DB_USER, value: manager}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                       key: manager-database-password}}}
        - {name: DB_HOST_READ_REPLICA, valueFrom: {secretKeyRef: {key: db.host,
                                                                  name: patchman-db-readonly}}}
        - {name: DB_PORT_READ_REPLICA, valueFrom: {secretKeyRef: {key: db.port,
                                                                  name: patchman-db-readonly}}}
        - {name: DB_READ_REPLICA_ENABLED, value: '${DB_READ_REPLICA_ENABLED}'}
        - {name: DB_WORK_MEM, value: '${DB_WORK_MEM}'}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVAL_TOPIC, value: '${EVAL_TOPIC_MANAGER}'}
        - {name: RESPONSE_TIMEOUT, value: '${RESPONSE_TIMEOUT}'}
        - {name: SSL_CERT_DIR, value: '${SSL_CERT_DIR}'}
        - {name: ENABLE_PROFILER, value: '${ENABLE_PROFILER_MANAGER}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_MANAGER}'}
        - {name: MAX_REQUEST_BODY_SIZE, value: '${MAX_REQUEST_BODY_SIZE}'}
        - {name: MAX_HEADER_COUNT, value: '${MAX_HEADER_COUNT}'}
        - {name: MAX_GIN_CONNECTIONS, value: '${MAX_GIN_CONNECTIONS}'}
        - {name: RATELIMIT, value: '${RATELIMIT}'}
        - {name: LIMIT_PAGE_SIZE, value: '${LIMIT_PAGE_SIZE}'}
        - {name: POD_CONFIG, value: '${MANAGER_CONFIG}'}

        resources:
          limits: {cpu: '${RES_LIMIT_CPU_MANAGER}', memory: '${RES_LIMIT_MEM_MANAGER}'}
          requests: {cpu: '${RES_REQUEST_CPU_MANAGER}', memory: '${RES_REQUEST_MEM_MANAGER}'}

    - name: listener
      minReplicas: ${{REPLICAS_LISTENER}}
      webServices:
        public:
          enabled: true
        private:
          enabled: true
        metrics:
          enabled: true
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_LISTENER}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - listener
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_LISTENER}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: SHOW_CLOWDER_VARS, value: ''}
        - {name: DB_DEBUG, value: '${DB_DEBUG_LISTENER}'}
        - {name: DB_USER, value: listener}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                        key: listener-database-password}}}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_READER_MAX_ATTEMPTS, value: '${KAFKA_READER_MAX_ATTEMPTS}'}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVENTS_TOPIC, value: platform.inventory.events}
        - {name: EVAL_TOPIC, value: patchman.evaluator.upload}
        - {name: PAYLOAD_TRACKER_TOPIC, value: platform.payload-status}
        - {name: TEMPLATE_TOPIC, value: platform.content-sources.template}
        - {name: ENABLE_PAYLOAD_TRACKER, value: '${ENABLE_PAYLOAD_TRACKER}'}
        - {name: ENABLE_PROFILER, value: '${ENABLE_PROFILER_LISTENER}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_LISTENER}'}
        - {name: POD_CONFIG, value: '${LISTENER_CONFIG}'}

        resources:
          limits: {cpu: '${RES_LIMIT_CPU_LISTENER}', memory: '${RES_LIMIT_MEM_LISTENER}'}
          requests: {cpu: '${RES_REQUEST_CPU_LISTENER}', memory: '${RES_REQUEST_MEM_LISTENER}'}

    - name: evaluator-upload
      minReplicas: ${{REPLICAS_EVALUATOR_UPLOAD}}
      webServices:
        public:
          enabled: true
        private:
          enabled: true
        metrics:
          enabled: true
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_EVALUATOR_UPLOAD}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - evaluator
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_EVALUATOR_UPLOAD}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: SHOW_CLOWDER_VARS, value: ''}
        - {name: DB_DEBUG, value: '${DB_DEBUG_EVALUATOR_UPLOAD}'}
        - {name: DB_USER, value: evaluator}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                       key: evaluator-database-password}}}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_READER_MAX_ATTEMPTS, value: '${KAFKA_READER_MAX_ATTEMPTS}'}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVAL_TOPIC, value: patchman.evaluator.upload}
        - {name: PAYLOAD_TRACKER_TOPIC, value: platform.payload-status}
        - {name: REMEDIATIONS_UPDATE_TOPIC, value: 'platform.remediation-updates.patch'}
        - {name: NOTIFICATIONS_TOPIC, value: 'platform.notifications.ingress'}
        - {name: MSG_BATCH_SIZE, value: '${MSG_BATCH_SIZE}'}
        - {name: ENABLE_PAYLOAD_TRACKER, value: '${ENABLE_PAYLOAD_TRACKER}'}
        - {name: USE_VMAAS_GO, value: '${USE_VMAAS_GO}'}
        - {name: SSL_CERT_DIR, value: '${SSL_CERT_DIR}'}
        - {name: GOGC, value: '${GOGC}'}  # set garbage collection limit for go 1.18
        - {name: ENABLE_PROFILER, value: '${ENABLE_PROFILER_EVALUATOR_UPLOAD}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_EVALUATOR}'}
        - {name: POD_CONFIG, value: 'label=upload;${EVALUATOR_UPLOAD_CONFIG}'}
        resources:
          limits: {cpu: '${RES_LIMIT_CPU_EVALUATOR_UPLOAD}', memory: '${RES_LIMIT_MEM_EVALUATOR_UPLOAD}'}
          requests: {cpu: '${RES_REQUEST_CPU_EVALUATOR_UPLOAD}', memory: '${RES_REQUEST_MEM_EVALUATOR_UPLOAD}'}

    - name: evaluator-recalc
      minReplicas: ${{REPLICAS_EVALUATOR_RECALC}}
      webServices:
        public:
          enabled: true
        private:
          enabled: true
        metrics:
          enabled: true
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_EVALUATOR_RECALC}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - evaluator
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_EVALUATOR_RECALC}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: SHOW_CLOWDER_VARS, value: ''}
        - {name: DB_DEBUG, value: '${DB_DEBUG_EVALUATOR_RECALC}'}
        - {name: DB_USER, value: evaluator}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                       key: evaluator-database-password}}}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_READER_MAX_ATTEMPTS, value: '${KAFKA_READER_MAX_ATTEMPTS}'}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVAL_TOPIC, value: patchman.evaluator.recalc}
        - {name: PAYLOAD_TRACKER_TOPIC, value: platform.payload-status}
        - {name: REMEDIATIONS_UPDATE_TOPIC, value: 'platform.remediation-updates.patch'}
        - {name: NOTIFICATIONS_TOPIC, value: 'platform.notifications.ingress'}
        - {name: MSG_BATCH_SIZE, value: '${MSG_BATCH_SIZE}'}
        - {name: ENABLE_PAYLOAD_TRACKER, value: 'false'}  # we don't need to send payload tracker messages from recalc
        - {name: USE_VMAAS_GO, value: '${USE_VMAAS_GO}'}
        - {name: SSL_CERT_DIR, value: '${SSL_CERT_DIR}'}
        - {name: GOGC, value: '${GOGC}'}  # set garbage collection limit for go 1.18
        - {name: ENABLE_PROFILER, value: '${ENABLE_PROFILER_EVALUATOR_RECALC}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_EVALUATOR}'}
        - {name: POD_CONFIG, value: 'label=recalc;${EVALUATOR_RECALC_CONFIG}'}
        resources:
          limits: {cpu: '${RES_LIMIT_CPU_EVALUATOR_RECALC}', memory: '${RES_LIMIT_MEM_EVALUATOR_RECALC}'}
          requests: {cpu: '${RES_REQUEST_CPU_EVALUATOR_RECALC}', memory: '${RES_REQUEST_MEM_EVALUATOR_RECALC}'}

    jobs:
    - name: vmaas-sync
      activeDeadlineSeconds: ${{JOBS_TIMEOUT}}
      schedule: ${VMAAS_SYNC_SCHEDULE}
      suspend: ${{VMAAS_SYNC_SUSPEND}}
      concurrencyPolicy: Forbid
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_JOBS}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - job
          - vmaas_sync
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_JOBS}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: SHOW_CLOWDER_VARS, value: ''}
        - {name: DB_DEBUG, value: '${DB_DEBUG_JOBS}'}
        - {name: DB_USER, value: vmaas_sync}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                       key: vmaas-sync-database-password}}}
        - {name: KAFKA_GROUP, value: patchman}
        - {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '${KAFKA_WRITER_MAX_ATTEMPTS}'}
        - {name: EVAL_TOPIC, value: patchman.evaluator.recalc}
        - {name: ENABLE_REPO_BASED_RE_EVALUATION, value: '${ENABLE_REPO_BASED_RE_EVALUATION}'}
        - {name: ENABLE_RECALC_MESSAGES_SEND, value: '${ENABLE_RECALC_MESSAGES_SEND}'}
        - {name: ENABLE_ADVISORIES_SYNC, value: '${ENABLE_ADVISORIES_SYNC}'}
        - {name: ENABLE_PACKAGES_SYNC, value: '${ENABLE_PACKAGES_SYNC}'}
        - {name: ENABLE_REPOS_SYNC, value: '${ENABLE_REPOS_SYNC}'}
        - {name: ENABLE_MODIFIED_SINCE_SYNC, value: '${ENABLE_MODIFIED_SINCE_SYNC}'}
        - {name: ERRATA_PAGE_SIZE, value: '${ERRATA_PAGE_SIZE}'}
        - {name: PACKAGES_PAGE_SIZE, value: '${PACKAGES_PAGE_SIZE}'}
        - {name: ENABLE_CYNDI_METRICS, value: '${ENABLE_CYNDI_METRICS}'}
        - {name: MSG_BATCH_SIZE, value: '${MSG_BATCH_SIZE}'}
        - {name: PROMETHEUS_PUSHGATEWAY,value: '${PROMETHEUS_PUSHGATEWAY}'}
        - {name: FULL_SYNC_CADENCE,value: '${FULL_SYNC_CADENCE}'}
        - {name: SSL_CERT_DIR, value: '${SSL_CERT_DIR}'}
        - {name: USE_VMAAS_GO, value: '${USE_VMAAS_GO}'}
        - {name: GOMEMLIMIT, value: '${GOMEMLIMIT_VMAAS_SYNC}'}
        resources:
          limits: {cpu: '${RES_LIMIT_CPU_VMAAS_SYNC}', memory: '${RES_LIMIT_MEM_VMAAS_SYNC}'}
          requests: {cpu: '${RES_REQUEST_CPU_VMAAS_SYNC}', memory: '${RES_REQUEST_MEM_VMAAS_SYNC}'}

    - name: system-culling
      activeDeadlineSeconds: ${{JOBS_TIMEOUT}}
      schedule: ${CULLING_SCHEDULE}
      suspend: ${{CULLING_SUSPEND}}
      concurrencyPolicy: Forbid
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_JOBS}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - job
          - system_culling
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_JOBS}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: DB_DEBUG, value: '${DB_DEBUG_JOBS}'}
        - {name: DB_USER, value: vmaas_sync}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                      key: vmaas-sync-database-password}}}
        - {name: DELETE_CULLED_SYSTEMS_LIMIT, value: '${DELETE_CULLED_SYSTEMS_LIMIT}'}
        - {name: ENABLE_CULLED_SYSTEM_DELETE, value: '${ENABLE_CULLED_SYSTEM_DELETE}'}
        - {name: ENABLE_SYSTEM_STALING, value: '${ENABLE_SYSTEM_STALING}'}
        - {name: PROMETHEUS_PUSHGATEWAY,value: '${PROMETHEUS_PUSHGATEWAY}'}

    - name: package-refresh
      activeDeadlineSeconds: ${{JOBS_TIMEOUT}}
      schedule: ${PKG_REFRESH_SCHEDULE}
      suspend: ${{PKG_REFRESH_SUSPEND}}
      concurrencyPolicy: Forbid
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_JOBS}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - job
          - packages_cache_refresh
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_JOBS}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: DB_DEBUG, value: '${DB_DEBUG_JOBS}'}
        - {name: DB_USER, value: vmaas_sync}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                      key: vmaas-sync-database-password}}}
        - {name: DB_HOST_READ_REPLICA, valueFrom: {secretKeyRef: {key: db.host,
                                                                  name: patchman-db-readonly}}}
        - {name: DB_PORT_READ_REPLICA, valueFrom: {secretKeyRef: {key: db.port,
                                                                  name: patchman-db-readonly}}}
        - {name: DB_READ_REPLICA_ENABLED, value: '${DB_READ_REPLICA_ENABLED_JOBS}'}
        - {name: DB_WORK_MEM, value: '${DB_WORK_MEM}'}
        - {name: PROMETHEUS_PUSHGATEWAY,value: '${PROMETHEUS_PUSHGATEWAY}'}

    - name: advisory-refresh
      activeDeadlineSeconds: ${{JOBS_TIMEOUT}}
      schedule: ${ADVISORY_REFRESH_SCHEDULE}
      suspend: ${{ADVISORY_REFRESH_SUSPEND}}
      concurrencyPolicy: Forbid
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_JOBS}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - job
          - advisory_cache_refresh
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_JOBS}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: DB_DEBUG, value: '${DB_DEBUG_JOBS}'}
        - {name: DB_USER, value: vmaas_sync}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                      key: vmaas-sync-database-password}}}
        - {name: ENABLE_REFRESH_ADVISORY_CACHES, value: '${ENABLE_REFRESH_ADVISORY_CACHES}'}
        - {name: SKIP_N_ACCOUNTS_REFRESH, value: '${SKIP_N_ACCOUNTS_REFRESH}'}

    - name: delete-unused
      activeDeadlineSeconds: ${{JOBS_TIMEOUT}}
      schedule: ${DELETE_UNUSED_SCHEDULE}
      suspend: ${{DELETE_UNUSED_SUSPEND}}
      concurrencyPolicy: Forbid
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG_JOBS}
        initContainers:
          - name: check-for-db
            image: ${IMAGE}:${IMAGE_TAG_DATABASE_ADMIN}
            command:
              - ./database_admin/check-upgraded.sh
            env:
            - {name: POD_CONFIG, value: '${DATABASE_ADMIN_CONFIG}'}
        command:
          - ./scripts/entrypoint.sh
          - job
          - delete_unused
        env:
        - {name: LOG_LEVEL, value: '${LOG_LEVEL_JOBS}'}
        - {name: GIN_MODE, value: '${GIN_MODE}'}
        - {name: DB_DEBUG, value: '${DB_DEBUG_JOBS}'}
        - {name: DB_USER, value: vmaas_sync}
        - {name: DB_PASSWD, valueFrom: {secretKeyRef: {name: patchman-engine-database-passwords,
                                                      key: vmaas-sync-database-password}}}
        - {name: DELETE_UNUSED_DATA_LIMIT, value: '${DELETE_UNUSED_DATA_LIMIT}'}
        - {name: ENABLE_UNUSED_DATA_DELETE, value: '${ENABLE_UNUSED_DATA_DELETE}'}

    database:
      name: patchman
      version: 16

    kafkaTopics:
    - {replicas: 3, partitions: 10, topicName: platform.inventory.events}
    - {replicas: 3, partitions: 10, topicName: patchman.evaluator.upload}
    - {replicas: 3, partitions: 10, topicName: patchman.evaluator.recalc}
    - {replicas: 3, partitions: 8, topicName: platform.payload-status}
    - {replicas: 3, partitions: 10, topicName: platform.remediation-updates.patch}
    - {replicas: 3, partitions: 10, topicName: platform.notifications.ingress}
    - {replicas: 3, partitions: 10, topicName: platform.content-sources.template}

    dependencies:
    - host-inventory
    - rbac
    - vmaas
    - ingress
    - puptoo
    - content-sources-backend
    cyndi:
      enabled: true
      appName: patch
      insightsOnly: true
      additionalFilters:
        - name: "nonCentOS"
          type: "com.redhat.insights.kafka.connect.transforms.Filter"
          if: "!record.headers().lastWithName('os_name').value().match(/centos/i)"
          where: "COALESCE(system_profile_facts->'operating_system'->>'name', '') NOT ILIKE '%centos%'"
        - name: "excludedReporters"
          type: "com.redhat.insights.kafka.connect.transforms.Filter"
          if: "!record.headers().lastWithName('reporter').value().match(/^(yupana|satellite|discovery|rhsm-conduit)$/i)"
          where: "reporter NOT IN ('yupana', 'satellite', 'discovery', 'rhsm-conduit')"
    testing:
      iqePlugin: patchman

- apiVersion: metrics.console.redhat.com/v1alpha1
  kind: FloorPlan
  metadata:
    name: patchman
  spec:
    database:
      secretName: ${FLOORIST_DB_SECRET_NAME}
    objectStore:
      secretName: ${FLOORIST_BUCKET_SECRET_NAME}
    suspend: ${{FLOORIST_SUSPEND}}
    logLevel: ${FLOORIST_LOGLEVEL}
    resources:
      limits:
        cpu: ${{RES_LIMIT_CPU_FLOORIST}}
        memory: ${{RES_LIMIT_MEM_FLOORIST}}
      requests:
        cpu: ${{RES_REQUEST_CPU_FLOORIST}}
        memory: ${{RES_REQUEST_MEM_FLOORIST}}
    queries:
      - prefix: insights/patch/advisories
        chunksize: ${{FLOORIST_CHUNKSIZE}}
        query: >-
          SELECT ra.name AS rh_account_id, am.name AS advisory_name, at.name AS advisory_type,
          count(sp.inventory_id) as applicable_systems
          FROM system_advisories sa
          JOIN system_platform sp ON sa.rh_account_id = sp.rh_account_id AND sa.system_id = sp.id
          JOIN inventory.hosts ih ON sp.inventory_id = ih.id
          JOIN advisory_metadata am ON sa.advisory_id = am.id
          JOIN rh_account ra ON ra.id = sa.rh_account_id
          JOIN advisory_type at ON am.advisory_type_id = at.id
          GROUP BY ra.name, am.name, at.name
          ORDER BY ra.name ASC, applicable_systems DESC;


- apiVersion: v1
  kind: Secret
  metadata:
    name: patchman-engine-database-passwords
    namespace: test  # namespace is overwritten by bonfire
  type: Opaque
  data:
    manager-database-password: bWFuYWdlcg== # manager
    listener-database-password: bGlzdGVuZXI= # listener
    evaluator-database-password: ZXZhbHVhdG9y # evaluator
    vmaas-sync-database-password: dm1hYXMtc3luYw== # vmaas-sync
    cyndi-database-password: Y3luZGk= # cyndi

- apiVersion: v1
  data:
    db.host: ""
    db.port: "MA=="
  kind: Secret
  metadata:
    name: patchman-db-readonly
    namespace: test  # namespace is overwritten by bonfire
  type: Opaque

parameters:
# Manager
- {name: REPLICAS_MANAGER, value: '1'}
- {name: IMAGE_TAG_MANAGER, value: v3.6.68}
- {name: LOG_LEVEL_MANAGER, value: debug}
- {name: DB_DEBUG_MANAGER, value: 'false'} # Log database queries if enabled
- {name: EVAL_TOPIC_MANAGER, value: patchman.evaluator.upload}
- {name: RES_LIMIT_CPU_MANAGER, value: 200m}
- {name: RES_LIMIT_MEM_MANAGER, value: 256Mi}
- {name: RES_REQUEST_CPU_MANAGER, value: 200m}
- {name: RES_REQUEST_MEM_MANAGER, value: 256Mi}
- {name: RESPONSE_TIMEOUT, value: '60'}
- {name: DB_READ_REPLICA_ENABLED, value: 'TRUE'}
- {name: ENABLE_PROFILER_MANAGER, value: 'false'}
- {name: GOMEMLIMIT_MANAGER, value: '230MiB'} # set to 90% of the default memory limit 256Mi (don't forget `B`)
- {name: MAX_REQUEST_BODY_SIZE, value: '1048576'} # limit request body size, in bytes (default 1MB)
- {name: MAX_HEADER_COUNT, value: '50'} # limit number of request headers
- {name: MAX_GIN_CONNECTIONS, value: '50'}
- {name: RATELIMIT, value: '100'} # requests per second for leaky bucket rate limiter
- {name: LIMIT_PAGE_SIZE, value: 'true'}  # page size is limited to 100 items per page, set to `false` to use any limit
- {name: MANAGER_CONFIG, value: ''}

# Listener
- {name: REPLICAS_LISTENER, value: '1'}
- {name: IMAGE_TAG_LISTENER, value: v3.6.68}
- {name: LOG_LEVEL_LISTENER, value: debug}
- {name: DB_DEBUG_LISTENER, value: 'false'}
- {name: RES_LIMIT_CPU_LISTENER, value: 250m}
- {name: RES_LIMIT_MEM_LISTENER, value: 192Mi}
- {name: RES_REQUEST_CPU_LISTENER, value: 250m}
- {name: RES_REQUEST_MEM_LISTENER, value: 192Mi}
- {name: ENABLE_PROFILER_LISTENER, value: 'false'}
- {name: GOMEMLIMIT_LISTENER, value: '172MiB'} # set to 90% of the default memory limit 192Mi (don't forget `B`)
- {name: LISTENER_CONFIG, value: 'consumer_count=8;allowed_reporters=puptoo,rhsm-system-profile-bridge;excluded_host_types=edge'}

# Evaluator
- {name: USE_VMAAS_GO, value: 'true'}
- {name: GOGC, value: '100'}
- {name: GOMEMLIMIT_EVALUATOR, value: '922MiB'} # set to 90% of the default memory limit 1024Mi (don't forget `B`)

# Evaluator - upload
- {name: REPLICAS_EVALUATOR_UPLOAD, value: '1'}
- {name: IMAGE_TAG_EVALUATOR_UPLOAD, value: v3.6.68}
- {name: LOG_LEVEL_EVALUATOR_UPLOAD, value: debug}
- {name: DB_DEBUG_EVALUATOR_UPLOAD, value: 'false'}
- {name: RES_LIMIT_CPU_EVALUATOR_UPLOAD, value: 256m}
- {name: RES_LIMIT_MEM_EVALUATOR_UPLOAD, value: 1024Mi}
- {name: RES_REQUEST_CPU_EVALUATOR_UPLOAD, value: 256m}
- {name: RES_REQUEST_MEM_EVALUATOR_UPLOAD, value: 1024Mi}
- {name: ENABLE_PROFILER_EVALUATOR_UPLOAD, value: 'false'}
- {name: EVALUATOR_UPLOAD_CONFIG, value: ''}

# Evaluator - recalc
- {name: REPLICAS_EVALUATOR_RECALC, value: '1'}
- {name: IMAGE_TAG_EVALUATOR_RECALC, value: v3.6.68}
- {name: LOG_LEVEL_EVALUATOR_RECALC, value: debug}
- {name: DB_DEBUG_EVALUATOR_RECALC, value: 'false'}
- {name: RES_LIMIT_CPU_EVALUATOR_RECALC, value: 256m}
- {name: RES_LIMIT_MEM_EVALUATOR_RECALC, value: 1024Mi}
- {name: RES_REQUEST_CPU_EVALUATOR_RECALC, value: 256m}
- {name: RES_REQUEST_MEM_EVALUATOR_RECALC, value: 1024Mi}
- {name: ENABLE_PROFILER_EVALUATOR_RECALC, value: 'false'}
- {name: EVALUATOR_RECALC_CONFIG, value: 'consumer_count=8'}

# JOBS
- {name: IMAGE_TAG_JOBS, value: v3.6.68}
- {name: LOG_LEVEL_JOBS, value: debug}
- {name: DB_DEBUG_JOBS, value: 'false'}
- {name: JOBS_TIMEOUT, value: '1800'}  # 30 min timeout for jobs
- {name: PROMETHEUS_PUSHGATEWAY, required: true, value: "pushgateway"}
- {name: DB_READ_REPLICA_ENABLED_JOBS, value: 'TRUE'}

# VMaaS sync
- {name: VMAAS_SYNC_SCHEDULE, value: '*/5 * * * *'} # Cronjob schedule definition
- {name: VMAAS_SYNC_SUSPEND, value: 'false'} # Disable cronjob execution
- {name: ENABLE_REPO_BASED_RE_EVALUATION, value: 'true'} # Optimize re-evaluation using repositories
- {name: ENABLE_RECALC_MESSAGES_SEND, value: 'true'} # Send re-calc messages after sync
- {name: ENABLE_ADVISORIES_SYNC, value: 'true'} # Enable advisories sync - part of sync process.
- {name: ENABLE_PACKAGES_SYNC, value: 'true'} # Enable packages sync - part of sync process.
- {name: ENABLE_REPOS_SYNC, value: 'true'} # Enable repos sync - part of sync process.
- {name: ENABLE_MODIFIED_SINCE_SYNC, value: 'false'} # Enable incremental sync using 'modified_since' param.
- {name: ERRATA_PAGE_SIZE, value: '500'} # Requested Vmaas response page size for advisories sync
- {name: PACKAGES_PAGE_SIZE, value: '5'} # Requested Vmaas response page size for packages sync
- {name: ENABLE_CYNDI_METRICS, value: 'true'} # Calculate and expose metrics about Cyndi data
- {name: RES_LIMIT_CPU_VMAAS_SYNC, value: 500m}
- {name: RES_LIMIT_MEM_VMAAS_SYNC, value: 384Mi}
- {name: RES_REQUEST_CPU_VMAAS_SYNC, value: 500m}
- {name: RES_REQUEST_MEM_VMAAS_SYNC, value: 384Mi}
- {name: FULL_SYNC_CADENCE, value: '168'}  # run full vmaas sync (default: 168h)
- {name: GOMEMLIMIT_VMAAS_SYNC, value: '345MiB'} # set to 90% of the default memory limit 384Mi (don't forget `B`)
# Delete unused data
- {name: DELETE_UNUSED_SCHEDULE, value: '10 */6 * * *'} # Cronjob schedule definition
- {name: DELETE_UNUSED_SUSPEND, value: 'true'} # Disable cronjob execution
- {name: DELETE_UNUSED_DATA_LIMIT, value: '1000'}  # Unused data deletion limit
- {name: ENABLE_UNUSED_DATA_DELETE, value: 'true'} # Unused data feature switch
# System culling
- {name: CULLING_SCHEDULE, value: '*/10 * * * *'} # Cronjob schedule definition
- {name: CULLING_SUSPEND, value: 'false'} # Disable cronjob execution
- {name: DELETE_CULLED_SYSTEMS_LIMIT, value: '1000'} # Culled systems deletion limit
- {name: ENABLE_CULLED_SYSTEM_DELETE, value: 'true'} # Enable deleting part of culling method
- {name: ENABLE_SYSTEM_STALING, value: 'true'} # Enable marking systems stale of culling method
# Cache refresh
- {name: PKG_REFRESH_SCHEDULE, value: '5 11-20/2 * * *'} # Cronjob schedule definition
- {name: PKG_REFRESH_SUSPEND, value: 'false'} # Disable cronjob execution
- {name: ADVISORY_REFRESH_SCHEDULE, value: '*/15 * * * *'} # Cronjob schedule definition
- {name: ADVISORY_REFRESH_SUSPEND, value: 'false'} # Disable cronjob execution
- {name: ENABLE_REFRESH_ADVISORY_CACHES, value: 'true'} # Enable periodic refresh of account advisory caches
- {name: SKIP_N_ACCOUNTS_REFRESH, value: '0'} # Skip advisory cache refresh for N first accounts in case the previous refresh didn't finish
# Migrate system package data
- {name: MIGRATE_SYSTEM_PACKAGE_DISABLED, value: 'false'}
- {name: RES_REQUEST_CPU_MIGRATE_JOB, value: '1'}
- {name: RES_LIMIT_CPU_MIGRATE_JOB, value: '2'}
- {name: RES_REQUEST_MEM_MIGRATE_JOB, value: '512Mi'}
- {name: RES_LIMIT_MEM_MIGRATE_JOB, value: '1024Mi'}
- {name: POC_MIGRATION_MAX_GOROUTINES, value: '4'}

# Database admin
- {name: IMAGE_TAG_DATABASE_ADMIN, value: v3.6.68}
- {name: LOG_LEVEL_DATABASE_ADMIN, value: debug}
- {name: DB_DEBUG_DATABASE_ADMIN, value: 'false'}
- {name: RES_LIMIT_CPU_DATABASE_ADMIN, value: 100m}
- {name: RES_LIMIT_MEM_DATABASE_ADMIN, value: 128Mi}
- {name: RES_REQUEST_CPU_DATABASE_ADMIN, value: 100m}
- {name: RES_REQUEST_MEM_DATABASE_ADMIN, value: 128Mi}
- {name: GOMEMLIMIT_DATABASE_ADMIN, value: '115MiB'} # set to 90% of the default memory limit 128Mi (don't forget `B`)
- {name: DATABASE_ADMIN_CONFIG, value: ''} # Set 'schema_version=XXX' if need specific database schema
                                           # 'force_schema_version=XXX' to reset the dirty flag to false and force the specific version, it will follow up with the schema upgrade defined by schema_version

# Common parameters
- {name: IMAGE, value: quay.io/cloudservices/patchman-engine-app}
- {name: ENV_NAME, required: false}
- {name: GIN_MODE, value: 'release'} # Gin webframework running mode
- {name: KAFKA_READER_MAX_ATTEMPTS, value: '3'} # Limit of how many attempts will be made before kafka read error.
- {name: KAFKA_WRITER_MAX_ATTEMPTS, value: '10'} # Limit of how many attempts will be made before kafka write error.
- {name: VMAAS_CALL_MAX_RETRIES, value: '8'} # Limit of how many unsuccessful vmaas calls are allowed before panic.
- {name: VMAAS_CALL_USE_EXP_RETRY, value: 'true'} # Use exponential retry policy for vmaas call.
- {name: MSG_BATCH_SIZE, value: '4000'} # BatchSize for PlatformEvent message
- {name: ENABLE_PAYLOAD_TRACKER, value: 'true'} # Send status messages to payload tracker
- {name: SSL_CERT_DIR, value: '/etc/ssl/certs:/etc/pki/tls/certs:/system/etc/security/cacerts:/cdapp/certs'}
- {name: DB_WORK_MEM, value: '512000'} # How much memory can query use (used for packages queries) in kB - 500MB, postgres default is 4MB

# Turnpike
- {name: IMAGE_TAG_ADMIN, value: v3.6.68}
- {name: ENABLE_TURNPIKE_AUTH, value: 'true'} # Enable Turnpike authentication for internal API (manual sync, re-calc)
- {name: REPLICAS_ADMIN, value: '1'}
- {name: RES_LIMIT_CPU_ADMIN, value: 100m}
- {name: RES_LIMIT_MEM_ADMIN, value: 256Mi}
- {name: RES_REQUEST_CPU_ADMIN, value: 50m}
- {name: RES_REQUEST_MEM_ADMIN, value: 128Mi}

# Floorist parameters
- {name: FLOORIST_SUSPEND, value: 'true', required: true} # Disable Floorist cronjob execution
- {name: FLOORIST_BUCKET_SECRET_NAME, value: dummy-secret, required: true} # Bucket secret name
- {name: FLOORIST_DB_SECRET_NAME, value: patchman-db} # DB secret name
- {name: FLOORIST_LOGLEVEL, value: INFO} # Floorist loglevel config
- {name: FLOORIST_CHUNKSIZE, value: '1000000'}
- {name: RES_REQUEST_CPU_FLOORIST, value: 250m}
- {name: RES_REQUEST_MEM_FLOORIST, value: 1Gi}
- {name: RES_LIMIT_CPU_FLOORIST, value: 500m}
- {name: RES_LIMIT_MEM_FLOORIST, value: 2Gi}
